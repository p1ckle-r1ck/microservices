# Домашнее задание к занятию «Микросервисы: подходы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: Обеспечить разработку

Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- облачная система;
- система контроля версий Git;
- репозиторий на каждый сервис;
- запуск сборки по событию из системы контроля версий;
- запуск сборки по кнопке с указанием параметров;
- возможность привязать настройки к каждой сборке;
- возможность создания шаблонов для различных конфигураций сборок;
- возможность безопасного хранения секретных данных (пароли, ключи доступа);
- несколько конфигураций для сборки из одного репозитория;
- кастомные шаги при сборке;
- собственные докер-образы для сборки проектов;
- возможность развернуть агентов сборки на собственных серверах;
- возможность параллельного запуска нескольких сборок;
- возможность параллельного запуска тестов.

Обоснуйте свой выбор.

## Ответ

GitLab CI/CD идеально подходит для централизованного управления сборками, так как является встроенной частью GitLab и предлагает возможности для работы с репозиториями и процессами CI/CD. 

### Компоненты

1. **Облачная система GitLab:**
    * Хостинг в облаке (GitLab SaaS) или собственное развертывание (self-hosted).
    * Управление репозиториями, настройками CI/CD и запуск сборок.
2. **GitLab Runners:**
    * Исполняющие агенты, которые запускают сборки и тесты.
    * Могут быть развернуты в облаке или на собственных серверах.
3. **Docker:**
    * Используется для выполнения сборок в изолированных окружениях.
    * Поддержка пользовательских Docker-образов.

### Выполнение требований

1. Облачная система
    * GitLab SaaS предоставляет полностью облачное решение.
    * Репозитории, пайплайны и секреты управляются централизованно через веб-интерфейс.
2. Система контроля версий Git
    * GitLab включает встроенную систему управления Git-репозиториями.
    * Каждый микросервис размещается в отдельном репозитории.
3. Запуск сборки по событию из системы контроля версий
    * Поддерживаются триггеры:
        * Push в ветку.
        * Создание Merge Request.
        * Теги, вебхуки или расписание.
4. Запуск сборки по кнопке с указанием параметров
    * Возможность запускать пайплайны вручную через интерфейс с передачей параметров (например, выбор окружения, версии).
5. Настройки для каждой сборки
    * Конфигурация сборки определяется в .gitlab-ci.yml, который хранится в репозитории.
    * Настройки можно привязывать к конкретным пайплайнам или этапам.
6. Шаблоны конфигураций
    * Поддержка повторно используемых файлов YAML (include).
    * Общие шаблоны сборок могут храниться в отдельном репозитории и подключаться при необходимости.
7. Безопасное хранение секретных данных
    * Секретные данные (пароли, ключи доступа) хранятся в разделе Variables.
    * Переменные защищены, шифруются и могут быть доступны только для определенных окружений или пайплайнов.
8. Несколько конфигураций для одного репозитория
    * Возможность создать разные задачи сборки для одной ветки или репозитория.
9. Кастомные шаги сборки
    * Поддержка любого количества этапов сборки (build, test, deploy).
    * Возможность выполнения скриптов на любом этапе.
10. Пользовательские Docker-образы
    * В GitLab Runners можно указать любой Docker-образ для выполнения сборки.
    * Сборка может быть выполнена в вашем собственном окружении.
11. Развертывание агентов на собственных серверах
    * GitLab Runners могут быть настроены для работы на ваших серверах (self-hosted Runners).
    * Позволяет использовать локальные ресурсы для выполнения задач.
12. Параллельные сборки
    * GitLab поддерживает параллельное выполнение нескольких сборок в рамках одного пайплайна. Ресурсы распределяются между задачами автоматически.
13. Параллельные тесты
    * Возможность разделить тесты на несколько задач, которые выполняются параллельно. Используется механизм parallel:, который распределяет выполнение тестов по разным агентам.

### Обоснование выбора

Я думаю, что GitLab CI/CD идеально подходит, т.к это единая экосистема, которая объединяет контроль версий и CI/CD в одном инструменте, что упрощает настройку и управление. Интуитивный интерфейс, с помощью которого можно управлять pipline-ами, мониторить сборки и управлять переменными и т.д. GitLab SaaS предоставляет готовую облачную инфраструктуру, не требующую настройки серверов. Возможность развернуть Runners как в облаке, так и локально. Ну и не надо забывать про отличную масштабируемость.


## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
- минимальные требования к приложениям, сбор логов из stdout;
- гарантированная доставка логов до центрального хранилища;
- обеспечение поиска и фильтрации по записям логов;
- обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- возможность дать ссылку на сохранённый поиск по записям логов.

Обоснуйте свой выбор.

## Ответ

Для для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре, я бы предложил использовать Elastic Stack (ELK).

### Компоненты решения

1. **Filebeat**
    * Легковесный агент для сбора логов с хостов.
    * Считывает логи из stdout.
    * Отправляет логи на центральный сервер через надежный транспорт (например, Logstash или напрямую в Elasticsearch).

2. **Logstash**
    * Центральный обработчик логов.
    * Выполняет предварительную обработку данных.
    * Обеспечивает надежную доставку логов в Elasticsearch.

3. **Elasticsearch**
    * Центральное хранилище логов.
    * Обеспечивает поиск и фильтрацию данных в реальном времени.
    * Поддерживает масштабируемость и гарантированную доставку (с помощью механизмов подтверждения записи).

4. **Kibana**
    * Визуализация и пользовательский интерфейс.
    * Обеспечивает поиск по записям, фильтрацию, создание дашбордов и сохранение запросов.
    * Позволяет делиться сохраненными поисками через ссылки.

### Взаимодействие компонентов

1. **Сбор логов:**
    * За сбор логов отвечает Filebeat, он  устанавливаются на каждом хосте и конфигурируются для чтения stdout и файлов логов.
    * Логи из контейнеров  автоматически перенаправляются в stdout поэтому дополнительные изменения не требуются.
2. **Доставка:**
    * Filebeat использует механизмы подтверждения при отправке данных.
    * Logstash  поддерживает очереди для обработки логов даже при временной недоступности Elasticsearch.
3. **Хранение и анализ:**
    * Elasticsearch хранит логи в виде JSON-документов, что упрощает поиск, фильтрацию и агрегацию.
    * Масштабируемость достигается за счет горизонтального масштабирования Elasticsearch-кластера.
4. **Интерфейс:**
    * Kibana предоставляет  UI для поиска по логам, создания фильтров и панелей мониторинга.
    * Разработчики могут сохранять запросы и делиться ссылками на сохраненные поиски. 

### Обоснование выбора

Данное решение соотвествует требованиям перечисленных выше. Оно легко масштабируется с ростом количества сервисов и хостов. Ну Elastic Stack популярный сервис для лог-менеджмента, с широкой документацией и поддержкой. 

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

- сбор метрик со всех хостов, обслуживающих систему;
- сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- сбор метрик, специфичных для каждого сервиса;
- пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.

Обоснуйте свой выбор.

## Ответ

Для реализации мониторинга я бы  выбрал  стек, основанный на Prometheus, Grafana, cAdvisor и OpenTelemetry.

1. **Prometheus** (сбор, хранение, обработка) 

    **Обоснование:**

    * Нативная поддержка мониторинга микросервисной архитектуры.
    * Работает на модели Pull.
    * Поддерживает экспортеры для системных метрик, контейнеров и сервисов.

    **Использование:**  
    Prometheus будет использоваться для сбора метрик:

    * Со всех хостов через node exporter
    * C контейнеров и сервисов через cAdvisor

2. **Node Exporter** (мониторинг хостов)
    
    **Обоснование:**
    * Легковесный агент для мониторинга системных ресурсов.
    * Работает с Prometheus.

    **Использование:** 
    * Установка на каждом хосте
    * отправка метрик хостов в Prometheus

3. **cAdvisor** (мониторинг контейнеров и сервисов)

    **Обоснование:**
    *Предоставляет детализированные метрики по использованию ресурсов контейнерами

    **Использование:** 
    * Запускается на всех хостах с контейнерами.
    * Передает в Prometheus метрики о потреблении ресурсов каждым контейнером и сервисом.

4. **OpenTelemetry** (специфичные метрики сервисов)

    **Обоснование:**
    * Стандарт для сбора бизнес-метрик и трассировок от приложений.
    * Поддерживает интеграцию с Prometheus для экспорта данных.

    **Использование:**

    * В каждом микросервисе добавляется библиотека OpenTelemetry.
    * Сервис отправляет специфичные метрики (например, количество запросов, ошибки, время обработки).
    * Метрики экспортируются в Prometheus через HTTP /metrics.

5. **Grafana** (интерфейс для запросов и панелей мониторинга)
    
    **Обоснование:**
    * Интуитивно понятный пользовательский интерфейс.
    * Поддержка запросов к Prometheus и других источников данных.
    * Возможность кастомизации панелей мониторинга.
